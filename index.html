<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>缶ふりリズムゲーム（15秒版）</title>
<style>
body { text-align: center; font-family: sans-serif; background: #f2f2f2; }
img { width: 80%; max-width: 320px; }
button { font-size: 20px; padding: 12px 24px; margin-top: 16px; }
#count { font-size: 28px; font-weight: bold; }
</style>
</head>
<body>

<h1>缶をリズムよくふれ！</h1>
<img id="gameImage" src="imgA.png">
<p>回数：<span id="count">0</span></p>

<button id="startBtn">スタート</button>

<audio id="bgm" src="handclap.mp3" preload="auto"></audio>

<script>
/* ===== 設定 ===== */
const PLAY_TIME = 15000;       // プレイ時間15秒
const CLEAR_COUNT = 8;         // 成功判定回数
const SHAKE_THRESHOLD = 25;    // 振る判定しきい値
const IDEAL_INTERVAL = 513;    // 117BPMに合わせて事前設定(ms)
const TOLERANCE = 250;         // ±ミリ秒の誤差
const MIN_INTERVAL = 200;      // 1回の振りとしてカウントする最小時間(ms)

/* ===== 変数 ===== */
let count = 0;
let playing = false;
let lastShakeTime = 0;
let toggle = false;
let endTimer;
let gameStartTime = 0;

/* ===== DOM ===== */
const img = document.getElementById("gameImage");
const countEl = document.getElementById("count");
const startBtn = document.getElementById("startBtn");
const bgm = document.getElementById("bgm");

/* ===== スタート ===== */
startBtn.onclick = async ()=>{
  if (typeof DeviceMotionEvent.requestPermission==='function'){
    const permission = await DeviceMotionEvent.requestPermission();
    if (permission!=='granted'){
      alert("センサーの使用を許可してください");
      return;
    }
  }

  count = 0;
  lastShakeTime = 0;
  toggle = false;
  playing = true;
  countEl.textContent = count;
  img.src = "imgA.png";
  startBtn.disabled = true;

  bgm.currentTime = 0;
  bgm.play();

  gameStartTime = Date.now();

  endTimer = setTimeout(endGame, PLAY_TIME);
};

/* ===== 振り判定（絶対時間方式） ===== */
window.addEventListener("devicemotion", (e)=>{
  if(!playing) return;
  const acc = e.accelerationIncludingGravity;
  if(!acc) return;

  const power = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
  const now = Date.now();

  if(power > SHAKE_THRESHOLD){
    // 前回の振りから短すぎる場合は無視
    if(now - lastShakeTime < MIN_INTERVAL) return;

    const elapsed = now - gameStartTime; // BGM再生開始からの経過時間
    const nearestBeat = Math.round(elapsed / IDEAL_INTERVAL) * IDEAL_INTERVAL;

    // 正解判定
    if(Math.abs(elapsed - nearestBeat) <= TOLERANCE){
      count++;
      countEl.textContent = count;

      toggle = !toggle;
      img.src = toggle ? "imgD.png" : "imgE.png";

      navigator.vibrate(80);
      countEl.style.transform = "scale(1.3)";
      setTimeout(()=>countEl.style.transform="scale(1)",150);
    }

    lastShakeTime = now;
  }
});

/* ===== 終了 ===== */
function endGame(){
  playing = false;
  startBtn.disabled = false;
  bgm.pause();

  if(count >= CLEAR_COUNT){
    img.src = "imgB.png";
    navigator.vibrate([200,100,200]);
  } else {
    img.src = "imgC.png";
  }
}
</script>

</body>
</html>
