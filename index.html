<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>缶ふりリズムゲーム</title>
<style>
body { text-align: center; font-family: sans-serif; background: #f2f2f2; }
img { width: 80%; max-width: 320px; }
button { font-size: 20px; padding: 12px 24px; margin-top: 16px; }
#count { font-size: 28px; font-weight: bold; }
</style>
</head>
<body>

<h1>缶をリズムよくふれ！</h1>
<img id="gameImage" src="imgA.png">
<p>回数：<span id="count">0</span></p>
<button id="startBtn">スタート</button>

<audio id="bgm" src="handclap.mp3" preload="auto"></audio>

<script>
/* ===== 設定 ===== */
const PLAY_TIME = 7000;
const CLEAR_COUNT = 8;
const SHAKE_THRESHOLD = 25;
let IDEAL_INTERVAL = 700;   // 正解判定テンポ（あとで調整）
const TOLERANCE = 250;

/* ===== 変数 ===== */
let count = 0;
let playing = false;
let lastShake = 0;
let lastInterval = null;
let toggle = false;
let endTimer;
let audioCtx;

/* ===== DOM ===== */
const img = document.getElementById("gameImage");
const countEl = document.getElementById("count");
const startBtn = document.getElementById("startBtn");
const bgm = document.getElementById("bgm");

/* ===== スタート ===== */
startBtn.onclick = async ()=>{
  if (typeof DeviceMotionEvent.requestPermission==='function'){
    const permission = await DeviceMotionEvent.requestPermission();
    if (permission!=='granted'){
      alert("センサーの使用を許可してください");
      return;
    }
  }
  count=0;
  lastShake=0;
  lastInterval=null;
  toggle=false;
  playing=true;
  countEl.textContent=count;
  img.src="imgA.png";
  startBtn.disabled=true;

  // BGM再生
  bgm.currentTime = 0;
  bgm.play();

  endTimer = setTimeout(endGame, PLAY_TIME);
};

/* ===== 振り判定（リズム判定） ===== */
window.addEventListener("devicemotion",(e)=>{
  if(!playing) return;
  const acc=e.accelerationIncludingGravity;
  if(!acc) return;
  const power=Math.abs(acc.x)+Math.abs(acc.y)+Math.abs(acc.z);
  const now=Date.now();
  if(power>SHAKE_THRESHOLD){
    if(lastShake===0){ lastShake=now; return; }
    const interval = now - lastShake;
    if(lastInterval===null){ lastInterval=interval; lastShake=now; return; }
    const diff=Math.abs(interval - lastInterval);
    if(diff < TOLERANCE){
      // 成功！
      lastInterval = interval;
      lastShake = now;
      count++;
      countEl.textContent = count;
      toggle=!toggle;
      img.src = toggle ? "imgD.png" : "imgE.png";
      navigator.vibrate(80);
      countEl.style.transform="scale(1.3)";
      setTimeout(()=>countEl.style.transform="scale(1)",150);
    } else {
      // リズムずれ → 学習し直し
      lastInterval = interval;
      lastShake = now;
    }
  }
});

/* ===== 終了 ===== */
function endGame(){
  playing=false;
  startBtn.disabled=false;
  bgm.pause();
  if(count >= CLEAR_COUNT){
    img.src="imgB.png";
    navigator.vibrate([200,100,200]);
  } else {
    img.src="imgC.png";
  }
}
</script>

</body>
</html>
